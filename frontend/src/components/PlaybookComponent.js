import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useLanguage } from '../contexts/LanguageContext';
import { useTranslation } from '../utils/translations';

const PlaybookComponent = ({ selectedDb, databases }) => {
  const navigate = useNavigate();
  const { language } = useLanguage();
  const { t } = useTranslation(language);
  const [playbooks, setPlaybooks] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');
  const [selectedCategory, setSelectedCategory] = useState(() => language === 'ko' ? 'Ï†ÑÏ≤¥' : 'All');
  const [expandedPlaybook, setExpandedPlaybook] = useState(null);

  // ÌîåÎ†àÏù¥Î∂Å Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
  const fetchPlaybooks = async () => {
    setLoading(true);
    try {
      const response = await fetch('/api/playbooks');
      if (response.ok) {
        const playbooksData = await response.json();
        setPlaybooks(playbooksData);
      } else {
        console.error('ÌîåÎ†àÏù¥Î∂Å Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®');
        setError(t('playbook.fetchError'));
      }
    } catch (error) {
      console.error('ÌîåÎ†àÏù¥Î∂Å Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:', error);
      setError(t('playbook.fetchError'));
    } finally {
      setLoading(false);
    }
  };

  // ÌîåÎ†àÏù¥Î∂Å Ïã§Ìñâ (AI Ï±ÑÌåÖÏúºÎ°ú Îã®Í≥ÑÎ≥Ñ Ïã§Ìñâ)
  const handleRunPlaybook = async (playbook) => {
    if (!selectedDb) {
      setError(t('playbook.selectDbFirst'));
      return;
    }

    setLoading(true);
    setError('');
    
    try {
      // AI Ï±ÑÌåÖ ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌïòÎ©¥ÏÑú ÌîåÎ†àÏù¥Î∂Å Ï†ïÎ≥¥ Ï†ÑÎã¨
      const playbookData = {
        name: playbook.name,
        description: playbook.description,
        category: playbook.category,
        steps: playbook.steps,
        selectedDb: selectedDb
      };
      
      // ÏÑ∏ÏÖò Ïä§ÌÜ†Î¶¨ÏßÄÏóê ÌîåÎ†àÏù¥Î∂Å Ï†ïÎ≥¥ Ï†ÄÏû•
      sessionStorage.setItem('runningPlaybook', JSON.stringify(playbookData));
      
      setSuccess(t('playbook.playbookRunning').replace('{name}', playbook.name));
      
      // AI Ï±ÑÌåÖ ÌéòÏù¥ÏßÄÎ°ú Î¶¨Îã§Ïù¥Î†âÌä∏
      setTimeout(() => {
        navigate('/chat');
      }, 1500);
      
    } catch (error) {
      setError(t('playbook.playbookError'));
    } finally {
      setLoading(false);
    }
  };

  // Ïπ¥ÌÖåÍ≥†Î¶¨ Î™©Î°ù ÏÉùÏÑ±
  const getCategories = () => {
    const allText = language === 'ko' ? 'Ï†ÑÏ≤¥' : 'All';
    const categories = [allText, ...new Set(playbooks.map(p => p.category).filter(Boolean))];
    return categories;
  };

  // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÌîåÎ†àÏù¥Î∂Å ÌïÑÌÑ∞ÎßÅ
  const getFilteredPlaybooks = () => {
    const allText = language === 'ko' ? 'Ï†ÑÏ≤¥' : 'All';
    if (selectedCategory === allText) {
      return playbooks;
    }
    return playbooks.filter(p => p.category === selectedCategory);
  };

  // ÌîåÎ†àÏù¥Î∂Å ÌôïÏû•/Ï∂ïÏÜå ÌÜ†Í∏Ä
  const togglePlaybookExpansion = (index) => {
    setExpandedPlaybook(expandedPlaybook === index ? null : index);
  };

  // Ïπ¥ÌÖåÍ≥†Î¶¨ ÌëúÏãúÎ™Ö Í∞ÄÏ†∏Ïò§Í∏∞
  const getDisplayCategoryName = (category) => {
    const allText = language === 'ko' ? 'Ï†ÑÏ≤¥' : 'All';
    if (category === allText) {
      return category;
    }
    
    // Î≤àÏó≠ ÏãúÎèÑ
    const translationKey = `playbook.categories.${category}`;
    const translated = t(translationKey);
    
    // Î≤àÏó≠Ïù¥ Ïã§Ìå®ÌñàÏúºÎ©¥ (ÌÇ§Í∞Ä Í∑∏ÎåÄÎ°ú Î∞òÌôòÎêòÎ©¥) ÏõêÎ≥∏ Ïπ¥ÌÖåÍ≥†Î¶¨Î™Ö ÏÇ¨Ïö©
    if (translated === translationKey) {
      return category;
    }
    
    return translated;
  };

  useEffect(() => {
    fetchPlaybooks();
  }, []);

  // Ïñ∏Ïñ¥ Î≥ÄÍ≤Ω Ïãú selectedCategory ÎèôÍ∏∞Ìôî
  useEffect(() => {
    const allText = language === 'ko' ? 'Ï†ÑÏ≤¥' : 'All';
    if (selectedCategory === 'Ï†ÑÏ≤¥' || selectedCategory === 'All') {
      setSelectedCategory(allText);
    }
  }, [language]);

  const filteredPlaybooks = getFilteredPlaybooks();

  return (
    <div className="page-content">
      <div className="page-header">
        <div className="section-header">
          <h2>üìñ {t('playbook.title')}</h2>
          <p>{t('playbook.description')}</p>
        </div>

        {/* ÌòÑÏû¨ ÏÑ†ÌÉùÎêú DB ÌëúÏãú */}
        {selectedDb && (
          <div className="current-db-info">
            <span className="db-label">{t('playbook.selectedDb')}:</span>
            <span className="db-name">{selectedDb}</span>
          </div>
        )}
      </div>

      <div className="page-body">
        {/* ÏÉÅÌÉú Î©îÏãúÏßÄ */}
        {error && (
          <div className="alert alert-error">
            <span>‚ö†Ô∏è {error}</span>
            <button onClick={() => setError('')} className="close-btn">‚úï</button>
          </div>
        )}
        
        {success && (
          <div className="alert alert-success">
            <span>‚úÖ {success}</span>
            <button onClick={() => setSuccess('')} className="close-btn">‚úï</button>
          </div>
        )}

        {/* DB ÏÑ†ÌÉù ÏïàÎÇ¥ */}
        {!selectedDb && (
          <div className="alert alert-warning">
            <span>{t('playbook.selectDbWarning')}</span>
          </div>
        )}

        {/* Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞ */}
        {playbooks.length > 0 && (
          <div className="category-filter">
            <h3>{t('common.filterByCategory')}</h3>
            <div className="category-buttons">
              {getCategories().map(category => {
                const allText = language === 'ko' ? 'Ï†ÑÏ≤¥' : 'All';
                const count = category === allText ? playbooks.length : playbooks.filter(p => p.category === category).length;
                return (
                  <button
                    key={category}
                    onClick={() => setSelectedCategory(category)}
                    className={`category-btn ${selectedCategory === category ? 'active' : ''}`}
                  >
                    {getDisplayCategoryName(category)} ({count})
                  </button>
                );
              })}
            </div>
          </div>
        )}

        {/* ÌîåÎ†àÏù¥Î∂Å Î™©Î°ù */}
        <div className="playbook-container">
          {loading ? (
            <div className="loading-state">
              <div className="loading-spinner"></div>
              <p>{t('playbook.loading')}</p>
            </div>
          ) : filteredPlaybooks.length === 0 ? (
            <div className="empty-state">
              <h3>{t('playbook.noPlaybooks')}</h3>
              <p>{selectedCategory === (language === 'ko' ? 'Ï†ÑÏ≤¥' : 'All') ? t('playbook.noAvailablePlaybooks') : t('playbook.noCategoryPlaybooks').replace('{category}', selectedCategory)}</p>
            </div>
          ) : (
            <div className="playbook-grid">
              {filteredPlaybooks.map((playbook, index) => (
                <div key={index} className="playbook-card">
                  <div className="playbook-header">
                    <div className="playbook-title-section">
                      <h3>{playbook.name}</h3>
                      {playbook.category && (
                        <span className={`playbook-category category-${playbook.category.replace(/\s+/g, '-').toLowerCase()}`}>
                          {playbook.category}
                        </span>
                      )}
                    </div>
                    <button
                      onClick={() => togglePlaybookExpansion(index)}
                      className="expand-btn"
                      title={expandedPlaybook === index ? (language === 'ko' ? 'Ï†ëÍ∏∞' : 'Collapse') : (language === 'ko' ? 'ÏûêÏÑ∏Ìûà Î≥¥Í∏∞' : 'Expand')}
                    >
                      {expandedPlaybook === index ? '‚ñ≤' : '‚ñº'}
                    </button>
                  </div>
                  
                  <div className="playbook-description">
                    <p>{playbook.description}</p>
                  </div>
                  
                  {expandedPlaybook === index && (
                    <div className="playbook-details">
                      <div className="playbook-steps">
                        <h4>üìã {t('playbook.executionSteps').replace('{count}', playbook.steps.length)}</h4>
                        <div className="steps-list">
                          {playbook.steps.map((step, stepIndex) => (
                            <div key={stepIndex} className="step-item">
                              <div className="step-number">{stepIndex + 1}</div>
                              <div className="step-content">
                                <div className="step-title">{step.title}</div>
                                <div className="step-prompt">{step.prompt}</div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  )}
                  
                  <div className="playbook-actions">
                    <button
                      onClick={() => handleRunPlaybook(playbook)}
                      className="btn btn-primary playbook-run-btn"
                      disabled={loading || !selectedDb}
                    >
                      {loading ? t('playbook.running') : t('playbook.runPlaybook')}
                    </button>
                    
                    <div className="playbook-meta">
                      <span className="meta-item">
                        ‚è±Ô∏è {t('playbook.estimatedTime')}: {playbook.estimatedTime || (language === 'ko' ? '2-5Î∂Ñ' : '2-5 min')}
                      </span>
                      <span className="meta-item">
                        üìä {t('playbook.steps').replace('{count}', playbook.steps.length)}
                      </span>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* ÏÇ¨Ïö©Î≤ï ÏïàÎÇ¥ */}
        <div className="usage-guide-section">
          <div className="card">
            <h3>{t('playbook.usageGuide')}</h3>
            <div className="guide-content">
              <div className="guide-steps">
                <div className="guide-step">
                  <span className="step-icon">1Ô∏è‚É£</span>
                  <div>
                    <strong>{t('playbook.selectDatabase')}</strong>
                    <p>{t('playbook.selectDatabaseDesc')}</p>
                  </div>
                </div>
                <div className="guide-step">
                  <span className="step-icon">2Ô∏è‚É£</span>
                  <div>
                    <strong>{t('playbook.selectPlaybook')}</strong>
                    <p>{t('playbook.selectPlaybookDesc')}</p>
                  </div>
                </div>
                <div className="guide-step">
                  <span className="step-icon">3Ô∏è‚É£</span>
                  <div>
                    <strong>{t('playbook.executeAndMonitor')}</strong>
                    <p>{t('playbook.executeAndMonitorDesc')}</p>
                  </div>
                </div>
              </div>
              
              <div className="guide-tips">
                <h4>üí° {t('common.tips')}</h4>
                <ul>
                  {language === 'ko' ? (
                    <>
                      <li><strong>Ï†ïÍ∏∞ Ï†êÍ≤Ä:</strong> Îß§Ïùº/Ï£ºÍ∞Ñ ÌîåÎ†àÏù¥Î∂ÅÏúºÎ°ú ÏãúÏä§ÌÖú ÏÉÅÌÉúÎ•º Ï†ïÍ∏∞Ï†ÅÏúºÎ°ú Ï≤¥ÌÅ¨ÌïòÏÑ∏Ïöî</li>
                      <li><strong>ÏÑ±Îä• ÏµúÏ†ÅÌôî:</strong> Ïä¨Î°úÏö∞ ÏøºÎ¶¨ÎÇò ÏÑ±Îä• Ïù¥Ïäà Î∞úÍ≤¨ Ïãú Í¥ÄÎ†® ÌîåÎ†àÏù¥Î∂ÅÏùÑ Ïã§ÌñâÌïòÏÑ∏Ïöî</li>
                      <li><strong>Î≥¥Ïïà Í∞êÏÇ¨:</strong> Í∞úÏù∏Ï†ïÎ≥¥ Î≥¥Ìò∏ Î∞è Î≥¥Ïïà Ï†êÍ≤ÄÏùÑ Ï†ïÍ∏∞Ï†ÅÏúºÎ°ú ÏàòÌñâÌïòÏÑ∏Ïöî</li>
                      <li><strong>Ïû•Ïï† ÎåÄÏùë:</strong> Í∏¥Í∏â ÏÉÅÌô© Ïãú ÏùëÍ∏â ÎåÄÏùë ÌîåÎ†àÏù¥Î∂ÅÏùÑ ÌôúÏö©ÌïòÏÑ∏Ïöî</li>
                    </>
                  ) : (
                    <>
                      <li><strong>Regular Checks:</strong> Use daily/weekly playbooks to regularly check system status</li>
                      <li><strong>Performance Optimization:</strong> Run related playbooks when slow queries or performance issues are found</li>
                      <li><strong>Security Audit:</strong> Regularly perform privacy protection and security checks</li>
                      <li><strong>Incident Response:</strong> Use emergency response playbooks in urgent situations</li>
                    </>
                  )}
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default PlaybookComponent; 
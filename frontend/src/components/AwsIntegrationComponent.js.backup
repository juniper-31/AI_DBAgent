// AwsIntegrationComponent.js
// AWS ì¸ì¦, RDS/CloudWatch ì—°ë™, ìƒíƒœ í‘œì‹œ
import React, { useState, useEffect } from 'react';

function AwsIntegrationComponent({ selectedDb, databases }) {
  const [authType, setAuthType] = useState('accessKey');
  const [accessKey, setAccessKey] = useState('');
  const [secretKey, setSecretKey] = useState('');
  const [sessionToken, setSessionToken] = useState('');
  const [ssoStartUrl, setSsoStartUrl] = useState('');
  const [ssoRegion, setSsoRegion] = useState('ap-northeast-2');
  const [ssoAccountId, setSsoAccountId] = useState('');
  const [ssoRoleName, setSsoRoleName] = useState('');
  const [awsRegion, setAwsRegion] = useState('us-east-1');
  const [cloudwatchNamespace, setCloudwatchNamespace] = useState('AWS/RDS');
  const [isConnected, setIsConnected] = useState(false);
  const [connectionStatus, setConnectionStatus] = useState('disconnected');
  const [rdsInstances, setRdsInstances] = useState([]);
  const [cloudwatchMetrics, setCloudwatchMetrics] = useState({});
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');

  const awsRegions = [
    { value: 'us-east-1', label: 'US East (N. Virginia)' },
    { value: 'us-east-2', label: 'US East (Ohio)' },
    { value: 'us-west-1', label: 'US West (N. California)' },
    { value: 'us-west-2', label: 'US West (Oregon)' },
    { value: 'ap-northeast-1', label: 'Asia Pacific (Tokyo)' },
    { value: 'ap-northeast-2', label: 'Asia Pacific (Seoul)' },
    { value: 'ap-southeast-1', label: 'Asia Pacific (Singapore)' },
    { value: 'ap-southeast-2', label: 'Asia Pacific (Sydney)' },
    { value: 'eu-west-1', label: 'Europe (Ireland)' },
    { value: 'eu-central-1', label: 'Europe (Frankfurt)' }
  ];

  // ì¸ì¦ ë°©ì‹ ì˜µì…˜
  const authTypes = [
    { value: 'accessKey', label: 'Access Key' },
    { value: 'iamRole', label: 'IAM Role (EC2/ECS/EKS)' },
    { value: 'sso', label: 'AWS SSO' }
  ];

  // AWS ì„¤ì • ë¡œë“œ
  useEffect(() => {
    loadAwsConfig();
  }, []);

  // AWS ì„¤ì • ë¡œë“œ
  const loadAwsConfig = async () => {
    try {
      const response = await fetch('/aws/auth');
      if (response.ok) {
        const config = await response.json();
        setAuthType(config.authType || 'accessKey');
        setAccessKey(config.accessKey || '');
        setSecretKey(config.secretKey || '');
        setSessionToken(config.sessionToken || '');
        setSsoStartUrl(config.ssoStartUrl || '');
        setSsoRegion(config.ssoRegion || 'ap-northeast-2');
        setSsoAccountId(config.ssoAccountId || '');
        setSsoRoleName(config.ssoRoleName || '');
        setAwsRegion(config.region || 'us-east-1');
        setCloudwatchNamespace(config.cloudwatchNamespace || 'AWS/RDS');
        setIsConnected(config.is_configured || false);
        setConnectionStatus(config.is_configured ? 'connected' : 'disconnected');
      }
    } catch (error) {
      console.error('AWS ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:', error);
    }
  };

  // ì—°ê²° í…ŒìŠ¤íŠ¸/ì €ì¥ í•¨ìˆ˜ì—ì„œ fetch bodyë¥¼ JSON.stringify(getAuthPayload())ë¡œ ë³€ê²½
  const handleTest = async (payload) => {
    setError('');
    setSuccess('');
    setLoading(true);
    try {
      const response = await fetch('/aws/auth/test', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
        credentials: 'include'
      });
      if (!response.ok) throw new Error('ì—°ê²°ì‹¤íŒ¨');
      const data = await response.json();
      if (data.success) {
        setSuccess('ì—°ê²° ì„±ê³µ!');
      } else {
        setError('ì—°ê²° ì‹¤íŒ¨: ' + (data.message || 'ì˜¤ë¥˜'));
      }
    } catch (e) {
      setError('ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setLoading(false);
    }
  };

  const handleSave = async (payload) => {
    setError('');
    setSuccess('');
    setLoading(true);
    try {
      const response = await fetch('/aws/auth', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
        credentials: 'include'
      });
      const data = await response.json();
      if (data.success) {
        setSuccess('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
      } else {
        setError('ì €ì¥ ì‹¤íŒ¨: ' + (data.message || 'ì˜¤ë¥˜'));
      }
    } catch (e) {
      setError('ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setLoading(false);
    }
  };

  // RDS ì¸ìŠ¤í„´ìŠ¤ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
  const fetchRdsInstances = async () => {
    if (!isConnected) return;

    setLoading(true);
    try {
      const response = await fetch('/aws/rds-instances');
      if (response.ok) {
        const data = await response.json();
        setRdsInstances(data.instances || []);
      } else {
        console.error('RDS ì¸ìŠ¤í„´ìŠ¤ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨');
      }
    } catch (error) {
      console.error('RDS ì¸ìŠ¤í„´ìŠ¤ ìš”ì²­ ì˜¤ë¥˜:', error);
    } finally {
      setLoading(false);
    }
  };

  // CloudWatch ë©”íŠ¸ë¦­ ê°€ì ¸ì˜¤ê¸°
  const fetchCloudWatchMetrics = async () => {
    if (!isConnected || !awsRegion) return;

    setLoading(true);
    try {
      const params = new URLSearchParams({
        region: awsRegion,
        namespace: cloudwatchNamespace
      });

      const response = await fetch(`/aws/cloudwatch/metrics?${params}`);
      if (response.ok) {
        const data = await response.json();
        setCloudwatchMetrics(data.metrics || {});
      } else {
        console.error('CloudWatch ë©”íŠ¸ë¦­ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨');
      }
    } catch (error) {
      console.error('CloudWatch ë©”íŠ¸ë¦­ ìš”ì²­ ì˜¤ë¥˜:', error);
    } finally {
      setLoading(false);
    }
  };

  // ì…ë ¥ í•„ë“œ ë³€ê²½ ì²˜ë¦¬
  const handleInputChange = (key, value) => {
    if (key === 'accessKey') setAccessKey(value);
    else if (key === 'secretKey') setSecretKey(value);
    else if (key === 'sessionToken') setSessionToken(value);
    else if (key === 'ssoStartUrl') setSsoStartUrl(value);
    else if (key === 'ssoRegion') setSsoRegion(value);
    else if (key === 'ssoAccountId') setSsoAccountId(value);
    else if (key === 'ssoRoleName') setSsoRoleName(value);
    else if (key === 'awsRegion') setAwsRegion(value);
    else if (key === 'cloudwatchNamespace') setCloudwatchNamespace(value);
  };

  // RDS ì¸ìŠ¤í„´ìŠ¤ ì„ íƒ
  const handleRdsInstanceSelect = (instanceId) => {
    handleInputChange('rds_instance_id', instanceId);
  };

  // ì—°ê²° ìƒíƒœì— ë”°ë¥¸ ìƒ‰ìƒ
  const getStatusColor = (status) => {
    switch (status) {
      case 'connected':
        return '#28a745';
      case 'connecting':
        return '#ffc107';
      case 'error':
        return '#dc3545';
      default:
        return '#6c757d';
    }
  };

  // ë©”íŠ¸ë¦­ ì¹´ë“œ ë Œë”ë§
  const renderMetricCard = (title, value, unit = '', status = null) => (
    <div className="metric-card">
      <div className="metric-header">
        <h4>{title}</h4>
        {status && (
          <span 
            className="status-badge"
            style={{ backgroundColor: getStatusColor(status) }}
          >
            {status}
          </span>
        )}
      </div>
      <div className="metric-value">
        <span className="value">{value}</span>
        {unit && <span className="unit">{unit}</span>}
      </div>
    </div>
  );

  // getAuthPayload í•¨ìˆ˜ë„ iamRole ì²˜ë¦¬ ì¶”ê°€
  const getAuthPayload = () => {
    if (authType === 'accessKey') {
      return {
        authType,
        accessKey,
        secretKey,
        sessionToken,
        awsRegion,
        cloudwatchNamespace
      };
    } else if (authType === 'iamRole') {
      return {
        authType,
        awsRegion,
        cloudwatchNamespace
      };
    } else {
      return {
        authType,
        ssoStartUrl,
        ssoRegion,
        ssoAccountId,
        ssoRoleName,
        awsRegion,
        cloudwatchNamespace
      };
    }
  };

  return (
    <div className="aws-integration-component">
      {/* í—¤ë” */}
      <div className="component-header">
        <div className="header-left">
          <h2>AWS í†µí•©</h2>
          <div className="connection-status">
            <span 
              className="status-indicator"
              style={{ backgroundColor: getStatusColor(connectionStatus) }}
            ></span>
            <span className="status-text">
              {connectionStatus === 'connected' && 'ì—°ê²°ë¨'}
              {connectionStatus === 'connecting' && 'ì—°ê²° ì¤‘...'}
              {connectionStatus === 'error' && 'ì—°ê²° ì˜¤ë¥˜'}
              {connectionStatus === 'disconnected' && 'ì—°ê²° ì•ˆë¨'}
            </span>
          </div>
        </div>
      </div>

      {/* AWS ì„¤ì • */}
      <div className="aws-config-section">
        <h3>AWS ì¸ì¦ ì„¤ì •</h3>
        
        {error && (
          <div className="error-message">{error}</div>
        )}

        <div className="form-group">
          <label htmlFor="auth-type">ì¸ì¦ ë°©ì‹</label>
          <select
            id="auth-type"
            value={authType}
            onChange={(e) => setAuthType(e.target.value)}
            className="form-control wide-input"
          >
            {authTypes.map(type => (
              <option key={type.value} value={type.value}>{type.label}</option>
            ))}
          </select>
        </div>

        {authType === 'accessKey' && (
          <>
            <div className="form-group">
              <label htmlFor="access-key">Access Key *</label>
              <input
                type="text"
                id="access-key"
                value={accessKey}
                onChange={e => setAccessKey(e.target.value)}
                placeholder="AKIA..."
                className="form-control wide-input"
              />
            </div>
            <div className="form-group">
              <label htmlFor="secret-key">Secret Key *</label>
              <input
                type="password"
                id="secret-key"
                value={secretKey}
                onChange={e => setSecretKey(e.target.value)}
                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                className="form-control wide-input"
              />
            </div>
            <div className="form-group">
              <label htmlFor="session-token">Session Token (ì˜µì…˜)</label>
              <input
                type="text"
                id="session-token"
                value={sessionToken}
                onChange={e => setSessionToken(e.target.value)}
                placeholder="ì„¸ì…˜ í† í° (í•„ìš”ì‹œ)"
                className="form-control wide-input"
              />
            </div>
          </>
        )}

        {authType === 'iamRole' && (
          <div className="form-group">
            <label>IAM Role ê¸°ë°˜ ì¸ì¦</label>
            <div style={{ color: '#888', fontSize: '14px' }}>
              EC2/ECS/EKS ì¸ìŠ¤í„´ìŠ¤ì— í• ë‹¹ëœ IAM Roleì„ ìë™ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.<br />
              ë³„ë„ì˜ í‚¤ ì…ë ¥ ì—†ì´ ì§„í–‰í•˜ì„¸ìš”.
            </div>
          </div>
        )}

        {authType === 'sso' && (
          <div className="config-form">
            <div className="form-row">
              <div className="form-group">
                <label htmlFor="sso-start-url">SSO Start URL *</label>
                <input
                  type="text"
                  id="sso-start-url"
                  value={ssoStartUrl}
                  onChange={(e) => handleInputChange('sso-start-url', e.target.value)}
                  placeholder="https://your-sso-portal.awsapps.com/start"
                  className="form-control wide-input"
                />
              </div>
              <div className="form-group">
                <label htmlFor="sso-region">SSO Region *</label>
                <input
                  type="text"
                  id="sso-region"
                  value={ssoRegion}
                  onChange={(e) => handleInputChange('sso-region', e.target.value)}
                  placeholder="ap-northeast-2"
                  className="form-control wide-input"
                />
              </div>
            </div>
            <div className="form-row">
              <div className="form-group">
                <label htmlFor="sso-account-id">SSO Account ID *</label>
                <input
                  type="text"
                  id="sso-account-id"
                  value={ssoAccountId}
                  onChange={(e) => handleInputChange('sso-account-id', e.target.value)}
                  placeholder="123456789012"
                  className="form-control wide-input"
                />
              </div>
              <div className="form-group">
                <label htmlFor="sso-role-name">SSO Role Name *</label>
                <input
                  type="text"
                  id="sso-role-name"
                  value={ssoRoleName}
                  onChange={(e) => handleInputChange('sso-role-name', e.target.value)}
                  placeholder="AWSAdministratorAccess"
                  className="form-control wide-input"
                />
              </div>
            </div>
          </div>
        )}

        <div className="form-row">
          <div className="form-group">
            <label htmlFor="aws-region">AWS ë¦¬ì „</label>
            <select
              id="aws-region"
              value={awsRegion}
              onChange={(e) => setAwsRegion(e.target.value)}
              className="form-control wide-input"
            >
              {awsRegions.map(region => (
                <option key={region.value} value={region.value}>
                  {region.label}
                </option>
              ))}
            </select>
          </div>
        </div>

        <div className="form-actions">
          <button 
            onClick={() => handleTest(getAuthPayload())}
            disabled={loading}
            className="btn btn-outline"
          >
            {loading ? 'í…ŒìŠ¤íŠ¸ ì¤‘...' : 'ğŸ”— ì—°ê²° í…ŒìŠ¤íŠ¸'}
          </button>
          
          <button 
            onClick={() => handleSave(getAuthPayload())}
            disabled={loading}
            className="btn btn-primary"
          >
            {loading ? 'ì €ì¥ ì¤‘...' : 'ğŸ’¾ ì„¤ì • ì €ì¥'}
          </button>
        </div>
      </div>

      {/* RDS ì¸ìŠ¤í„´ìŠ¤ ê´€ë¦¬ */}
      {isConnected && (
        <div className="rds-section">
          <div className="section-header">
            <h3>RDS ì¸ìŠ¤í„´ìŠ¤ ê´€ë¦¬</h3>
            <button 
              onClick={fetchRdsInstances}
              disabled={loading}
              className="btn btn-outline"
            >
              {loading ? 'ë¡œë”© ì¤‘...' : 'ğŸ”„ ì¸ìŠ¤í„´ìŠ¤ ëª©ë¡ ìƒˆë¡œê³ ì¹¨'}
            </button>
          </div>

          <div className="form-group">
            <label htmlFor="rds_instance_id">RDS ì¸ìŠ¤í„´ìŠ¤ ì„ íƒ</label>
            <select
              id="rds_instance_id"
              value={selectedDb}
              onChange={(e) => handleRdsInstanceSelect(e.target.value)}
              className="form-control wide-input"
            >
              <option value="">ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
              {rdsInstances.map(instance => (
                <option key={instance.DBInstanceIdentifier} value={instance.DBInstanceIdentifier}>
                  {instance.DBInstanceIdentifier} ({instance.DBInstanceClass}) - {instance.DBInstanceStatus}
                </option>
              ))}
            </select>
          </div>

          {selectedDb && (
            <div className="instance-info">
              <h4>ì„ íƒëœ ì¸ìŠ¤í„´ìŠ¤ ì •ë³´</h4>
              {rdsInstances.find(i => i.DBInstanceIdentifier === selectedDb) && (
                <div className="info-grid">
                  <div className="info-item">
                    <label>ì¸ìŠ¤í„´ìŠ¤ ID:</label>
                    <span>{selectedDb}</span>
                  </div>
                  <div className="info-item">
                    <label>ì—”ì§„:</label>
                    <span>{rdsInstances.find(i => i.DBInstanceIdentifier === selectedDb)?.Engine}</span>
                  </div>
                  <div className="info-item">
                    <label>ìƒíƒœ:</label>
                    <span>{rdsInstances.find(i => i.DBInstanceIdentifier === selectedDb)?.DBInstanceStatus}</span>
                  </div>
                  <div className="info-item">
                    <label>ì—”ë“œí¬ì¸íŠ¸:</label>
                    <span>{rdsInstances.find(i => i.DBInstanceIdentifier === selectedDb)?.Endpoint?.Address}</span>
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      )}

      {/* CloudWatch ë©”íŠ¸ë¦­ */}
      {isConnected && selectedDb && (
        <div className="cloudwatch-section">
          <div className="section-header">
            <h3>CloudWatch ë©”íŠ¸ë¦­</h3>
            <button 
              onClick={fetchCloudWatchMetrics}
              disabled={loading}
              className="btn btn-outline"
            >
              {loading ? 'ë¡œë”© ì¤‘...' : 'ğŸ“Š ë©”íŠ¸ë¦­ ìƒˆë¡œê³ ì¹¨'}
            </button>
          </div>

          <div className="metrics-grid">
            {renderMetricCard(
              'CPU ì‚¬ìš©ë¥ ',
              cloudwatchMetrics.cpu_utilization || 0,
              '%',
              cloudwatchMetrics.cpu_utilization > 80 ? 'warning' : 'ok'
            )}
            
            {renderMetricCard(
              'ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ ',
              cloudwatchMetrics.freeable_memory || 0,
              'MB',
              cloudwatchMetrics.freeable_memory < 1000 ? 'warning' : 'ok'
            )}
            
            {renderMetricCard(
              'ì—°ê²° ìˆ˜',
              cloudwatchMetrics.database_connections || 0,
              'ê°œ',
              cloudwatchMetrics.database_connections > 100 ? 'warning' : 'ok'
            )}
            
            {renderMetricCard(
              'ì½ê¸° IOPS',
              cloudwatchMetrics.read_iops || 0,
              'IOPS',
              null
            )}
            
            {renderMetricCard(
              'ì“°ê¸° IOPS',
              cloudwatchMetrics.write_iops || 0,
              'IOPS',
              null
            )}
            
            {renderMetricCard(
              'ë„¤íŠ¸ì›Œí¬ ì²˜ë¦¬ëŸ‰',
              cloudwatchMetrics.network_receive_throughput || 0,
              'MB/s',
              null
            )}
          </div>

          {/* ë©”íŠ¸ë¦­ ì°¨íŠ¸ (ê°„ë‹¨í•œ í‘œ í˜•íƒœ) */}
          {Object.keys(cloudwatchMetrics).length > 0 && (
            <div className="metrics-table">
              <h4>ìƒì„¸ ë©”íŠ¸ë¦­</h4>
              <table className="table">
                <thead>
                  <tr>
                    <th>ë©”íŠ¸ë¦­ëª…</th>
                    <th>ê°’</th>
                    <th>ë‹¨ìœ„</th>
                    <th>ìƒíƒœ</th>
                  </tr>
                </thead>
                <tbody>
                  {Object.entries(cloudwatchMetrics).map(([key, value]) => (
                    <tr key={key}>
                      <td>{key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</td>
                      <td>{typeof value === 'number' ? value.toFixed(2) : value}</td>
                      <td>{getMetricUnit(key)}</td>
                      <td>
                        <span 
                          className="status-badge"
                          style={{ backgroundColor: getMetricStatusColor(key, value) }}
                        >
                          {getMetricStatus(key, value)}
                        </span>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      )}

      {/* ë³´ì•ˆ ì£¼ì˜ì‚¬í•­ */}
      <div className="security-notice">
        <h4>ğŸ”’ ë³´ì•ˆ ì£¼ì˜ì‚¬í•­</h4>
        <ul>
          <li>AWS ìê²© ì¦ëª…ì€ ì•ˆì „í•˜ê²Œ ì•”í˜¸í™”ë˜ì–´ ì €ì¥ë©ë‹ˆë‹¤.</li>
          <li>ìµœì†Œ ê¶Œí•œ ì›ì¹™ì— ë”°ë¼ í•„ìš”í•œ ê¶Œí•œë§Œ ë¶€ì—¬í•˜ì„¸ìš”.</li>
          <li>ì •ê¸°ì ìœ¼ë¡œ ì•¡ì„¸ìŠ¤ í‚¤ë¥¼ êµì²´í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.</li>
          <li>í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” IAM ì—­í•  ì‚¬ìš©ì„ ê³ ë ¤í•˜ì„¸ìš”.</li>
        </ul>
      </div>
    </div>
  );
}

// ë©”íŠ¸ë¦­ ë‹¨ìœ„ ë°˜í™˜
const getMetricUnit = (metricName) => {
  const units = {
    cpu_utilization: '%',
    freeable_memory: 'MB',
    database_connections: 'ê°œ',
    read_iops: 'IOPS',
    write_iops: 'IOPS',
    network_receive_throughput: 'MB/s',
    network_transmit_throughput: 'MB/s'
  };
  return units[metricName] || '';
};

// ë©”íŠ¸ë¦­ ìƒíƒœ ìƒ‰ìƒ ë°˜í™˜
const getMetricStatusColor = (metricName, value) => {
  if (metricName === 'cpu_utilization' && value > 80) return '#ffc107';
  if (metricName === 'freeable_memory' && value < 1000) return '#ffc107';
  if (metricName === 'database_connections' && value > 100) return '#ffc107';
  return '#28a745';
};

// ë©”íŠ¸ë¦­ ìƒíƒœ ë°˜í™˜
const getMetricStatus = (metricName, value) => {
  if (metricName === 'cpu_utilization' && value > 80) return 'warning';
  if (metricName === 'freeable_memory' && value < 1000) return 'warning';
  if (metricName === 'database_connections' && value > 100) return 'warning';
  return 'ok';
};

export default AwsIntegrationComponent; 